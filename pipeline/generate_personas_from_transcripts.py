#!/usr/bin/env python3
"""
Генерация персон из .txt расшифровок:
- читает все .txt из входной папки
- вызывает LLM для сборки карточки персоны (Markdown)
- сохраняет карточки в output/cards_md/
- добавляет записи в SQLite БД (personas.sqlite)
"""
import argparse
import hashlib
import json
import os
import sqlite3
import hashlib
from datetime import datetime
from pathlib import Path
import re
import sys

ROOT = Path(__file__).resolve().parents[1]
if str(ROOT) not in sys.path:
    sys.path.append(str(ROOT))
from tools.llm_client import LLMClient  # noqa: E402


def slugify(text: str, max_len: int = 60) -> str:
    text = re.sub(r"\s+", "-", text.strip())
    text = re.sub(r"[^a-zA-Z0-9а-яА-ЯёЁ_-]", "", text)
    text = re.sub(r"-{2,}", "-", text)
    return text[:max_len].strip("-_")


PROMPT_SYSTEM = """Ты — эксперт-аналитик маркетинговых исследований, специализирующийся на составлении психологических профилей респондентов по материалам глубинных интервью.

## ЗАДАЧА
Проанализируй расшифровку интервью и составь детальный профиль респондента, извлекая как базовые социально-демографические данные, так и глубинные поведенческие и психологические атрибуты.

## СТРУКТУРА АНАЛИЗА

### 1. ЯРКИЙ ЗАГОЛОВОК ПРОФИЛЯ
Создай емкое описание (5-10 слов), которое мгновенно формирует образ персонажа. Это должна быть яркая, запоминающаяся характеристика, отражающая суть человека.

Примеры стиля:
- "Выгоревший IT-шник 35 лет из Москвы"
- "Амбициозная провинциальная студентка с комплексами"
- "Многодетная мать в декрете, ищущая себя"

---

### 2. САММАРИ ОТ ПЕРВОГО ЛИЦА

Напиши краткий рассказ о себе от лица респондента (150-250 слов). Это должен быть живой, естественный текст, который:

**Требования к саммари:**
- Написан от первого лица («Я...», «Мне...», «У меня...»)
- **Максимально точно передает речевую манеру респондента:**
  - Используй характерные слова и выражения из интервью
  - Сохраняй уровень образованности речи (простой/сложный язык)
  - Копируй эмоциональную окраску (сдержанность/экспрессивность)
  - Отражай темп речи (короткие рубленые фразы или длинные развернутые)
  - Включай характерные паразитические слова или обороты (если есть)
- Охватывает ключевые аспекты: кто, чем занимается, что важно, какие проблемы, к чему стремится
- Звучит естественно, как будто человек сам рассказывает о себе знакомому
- Передает эмоциональный тон и внутреннее состояние

**Примеры стилистических различий:**

*Пример 1 (уставшая мать, простая речь):*
> "Мне 34, трое детей. Работаю удаленно, потому что в офис никак — кто с детьми сидеть будет? Вечно все на мне: уроки, кружки, готовка. Устаю жутко. Хочется хоть немного времени для себя, но его просто нет. Пытаюсь хоть что-то автоматизировать, приложения всякие ставлю, но толку мало. Муж помогает, но он всегда занят. В общем, выживаю как могу."

*Пример 2 (IT-специалист, техничная речь):*
> "Я Senior developer, работаю в аутсорсе уже лет восемь. Знаете, выгорание — это реально. Проекты интересные, но менеджмент убивает: постоянные митинги, неадекватные дедлайны, легаси-код, который никто не хочет рефакторить. Думаю о переходе в продуктовую компанию, но там свои геморрои. Ценю автономность, не люблю микроменеджмент. Хочу работать с умными людьми над чем-то осмысленным, а не клепать очередной CRUD."

*Пример 3 (тревожный перфекционист):*
> "Мне всегда важно всё сделать правильно, понимаете? Я не могу просто так, наспех. Надо проверить, перепроверить, убедиться. Коллеги иногда говорят, что я слишком много времени трачу на детали, но... меня же потом спросят, если что-то пойдет не так. Я очень переживаю, когда что-то идет не по плану. Стараюсь всё контролировать, но это выматывает, честно."

---

### 3. СОЦИАЛЬНО-ДЕМОГРАФИЧЕСКИЙ ПРОФИЛЬ
- **Пол:** 
- **Возраст:** (точный или диапазон с обоснованием)
- **Место проживания:** (город, тип населенного пункта)
- **Семейное положение:** (с деталями: один/замужем/дети/живет с родителями)
- **Образование:** (уровень, область)
- **Доход:** (уровень, финансовое положение - если можно определить)

### 4. РОД ДЕЯТЕЛЕЛЬНОСТИ
- **Текущая занятость:** (должность, сфера, формат работы)
- **Карьерная траектория:** (амбиции, удовлетворенность, планы)
- **Отношение к работе:** (что мотивирует, что тяготит)
- **Уровень компетентности/опыта:** (навыки, экспертность, уверенность в профессиональной области)

---

### 5. ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ

#### 5.1. Ценности и установки
Что человек считает важным в жизни, работе, продуктовом опыте. Его принципы, отношение к технологиям, деньгам, времени.

**Маркеры речи:** «Я считаю, что…», «Для меня принципиально…», «Никогда не делаю…»

#### 5.2. Самооценка и уверенность
Как оценивает себя, свои компетенции, свои возможности.

#### 5.3. Эмоциональный профиль
- **Общий эмоциональный фон:** (настроение, тревожность, энергия)
- **Эмоциональные реакции:** (что вызывает радость, раздражение, страх, восторг)
- **Интенсивность эмоций:** (сдержанный/экспрессивный)

**Маркеры речи:** «Ненавижу, когда…», «Очень нравится, что…», «Это меня пугает»

#### 5.4. Страхи и тревоги
Явные и скрытые опасения, источники беспокойства.

#### 5.5. Механизмы защиты
Как справляется с проблемами, стрессом, неопределенностью.

---

### 6. ЦЕЛЕВОЙ ПРОФИЛЬ

#### 6.1. Цели и задачи
Желаемые результаты, стремления, задачи, которые пользователь хочет решить.

**Маркеры речи:** «Мне важно…», «Я хочу…», «Мне нужно, чтобы…», «Я пытаюсь добиться…»

**Примеры:** «Хочу быстрее оформлять документы», «Чтобы было спокойно и понятно»

#### 6.2. Мотивации
Глубинные причины поведения: зачем человек вообще решил заняться задачей или искать решение. Что движет им изнутри.

**Маркеры речи:** «Мне важно, чтобы…», «Я выбираю так, потому что…», «Меня мотивирует…»

**Примеры:** «Мне важно чувствовать контроль», «Чтобы не тратить время на рутину»

#### 6.3. Ожидания и критерии качества
Каким пользователь видит «хорошее решение»; что должно быть в продукте, чтобы он подходил.

**Маркеры речи:** «Хочется, чтобы…», «Для меня важно, чтобы система умела…», «Хороший сервис — это тот, который…»

**Примеры:** «Хочу, чтобы всё было быстро и понятно», «Чтобы ничего не висло»

---

### 7. ПРОБЛЕМЫ И БАРЬЕРЫ

#### 7.1. Проблемы и боли (Pain Points)
Фрустрации, раздражители, препятствия, негативные переживания. Что мешает сейчас.

**Маркеры речи:** «Меня бесит…», «Очень неудобно, что…», «Постоянно сталкиваюсь с тем, что…»

**Примеры:** «Заполнять отчёт каждый месяц — это ад», «Постоянно забываю пароль»

#### 7.2. Барьерные факторы
Что мешает действовать: внутренняя неуверенность, внешние ограничения, отсутствие навыков, страхи.

**Маркеры речи:** «Мне сложно…», «Не понимаю, как…», «Постоянно откладываю, потому что…»

**Примеры:** «Боюсь ошибиться», «Не разбираюсь в интерфейсе»

#### 7.3. Ресурсные ограничения
Время, деньги, оборудование, навыки, доступность инструментов.

**Маркеры речи:** «У меня нет времени…», «У нас нет бюджета…», «Компьютер слабый…»

**Примеры:** «Делаю всё с телефона, потому что ноутбук старый»

---

### 8. ПОВЕДЕНЧЕСКИЙ ПРОФИЛЬ

#### 8.1. Поведенческие паттерны и стратегии
Типичные действия, предпочтительные способы решения задач, привычки, последовательности действий.

**Маркеры речи:** «Обычно я делаю так…», «Я привык…», «Всегда сначала проверяю…», «У меня такой ритуал…»

**Примеры:** «Всегда ищу отзывы перед покупкой», «Делаю всё в последний момент»

#### 8.2. Триггеры к действию
Что запускает активность: событие, обстоятельство, эмоция. Что предшествует действию.

**Маркеры речи:** «Обычно начинаю, когда…», «Как только случается…, я сразу…», «Меня подталкивает…»

**Примеры:** «Приходит письмо — сразу делаю», «Как только начальник спрашивает — бросаю всё»

#### 8.3. Предпочтения в интерфейсе и взаимодействии
Как и чем любит пользоваться: мобильный/десктоп, кнопки/поиск, чаты/инструкции. Предпочитаемый стиль UI, подача информации.

**Маркеры речи:** «Мне удобнее, когда…», «Не люблю чат-ботов», «Всегда использую поиск»

**Примеры:** «Дайте мне одну кнопку, я разберусь», «Хочу видеть всё списком, без иконок»

---

### 9. ОБРАЗ ЖИЗНИ И КОНТЕКСТ

#### 9.1. Распорядок дня
Типичный день, режим, ритм жизни.

#### 9.2. Контекст использования
Условия, окружение, где и при каких обстоятельствах пользователь решает задачу. Среда, ограничения, роли.

**Маркеры речи:** «Я делаю это по дороге…», «На работе у меня нет времени…», «Обычно это происходит, когда…»

**Примеры:** «На работе нет доступа к нормальному компьютеру», «Делаю это только вечером, когда дети спят»

#### 9.3. Хобби и увлечения

#### 9.4. Социальная активность
Круг общения, частота контактов.

#### 9.5. Социальный контекст и влияния
Люди и факторы, влияющие на решения: коллеги, начальники, семья, друзья, сообщества.

**Маркеры речи:** «Коллеги сказали, что…», «Дома меня просят…», «Начальник требует, чтобы…»

**Примеры:** «Жена говорит, что я слишком долго выбираю», «Команда предпочитает работать в Jira — поэтому я тоже»

#### 9.6. Цифровое поведение
Какие сервисы использует, как проводит время онлайн, цифровые привычки.

#### 9.7. Потребительское поведение
На что тратит, что ценит в покупках, как принимает решения.

---

### 10. КЛЮЧЕВЫЕ ИНСАЙТЫ
Выдели 5-7 самых важных наблюдений, которые помогают понять мотивацию и поведение респондента в контексте использования интернет-сервисов. Каждый инсайт подкрепи цитатой или конкретным примером из текста.

---

## ВАЖНЫЕ ПРИНЦИПЫ АНАЛИЗА

### 1. Читай между строк
Обращай внимание не только на прямые высказывания, но и на:
- Оговорки и паузы (если указаны)
- Противоречия в словах
- Эмоциональную окраску речи
- Повторяющиеся темы и слова
- То, что НЕ говорится, но подразумевается

### 2. Используй маркеры речи
В материалах указаны типичные речевые паттерны для каждого атрибута. Активно ищи их в тексте.

### 3. Ищи паттерны и повторения
Повторяющиеся темы, слова, жалобы или восторги — это маркеры важных аспектов личности.

### 4. Будь конкретным и доказательным
- Подкрепляй КАЖДЫЙ вывод цитатами или конкретными примерами из текста
- Указывай, на основании чего сделан вывод
- Если информации недостаточно — честно признавай это

### 5. Указывай уровень уверенности
Если что-то неочевидно, используй формулировки:
- «Вероятно…» (есть косвенные указания)
- «Возможно…» (слабые признаки)
- «Явно/очевидно…» (прямые высказывания)
- «Не удалось определить» (недостаточно данных)

### 6. Избегай оценочности
Описывай, не осуждая:
- «Тревожный» вместо «параноик»
- «Экономный» вместо «жадный»
- «Перфекционист» вместо «зануда»
- «Спонтанный» вместо «безответственный»

### 7. Различай слои информации
- **Что говорит** (прямые высказывания)
- **Как говорит** (эмоциональная окраска, интенсивность)
- **Что за этим стоит** (глубинные мотивы, страхи, ценности)

### 8. Не заполняй пункты формально
Если по какому-то атрибуту нет информации в интервью — так и пиши: «Информация не обнаружена» или «Недостаточно данных для вывода».

### 9. Для саммари — анализируй речевую манеру
Перед написанием саммари обрати внимание на:
- **Словарный запас:** использует ли профессиональный жаргон, сленг, простую или усложненную лексику
- **Длина предложений:** короткие рубленые фразы или развернутые сложные конструкции
- **Эмоциональность:** много ли восклицаний, усилений («очень», «жутко», «капец»)
- **Характерные словечки:** «типа», «как бы», «в общем», «знаете», «понимаете»
- **Степень рефлексии:** говорит ли о чувствах подробно или сухо констатирует факты
- **Уровень уверенности:** категоричные утверждения или постоянные сомнения («наверное», «может быть»)

---

## ФОРМАТ ОТВЕТА

# [ЯРКИЙ ЗАГОЛОВОК]

## Саммари от первого лица

[Текст 150-250 слов, написанный от лица респондента, с сохранением его речевой манеры]

---

## Социально-демографический профиль
[заполнение с указанием источника выводов]

## Род деятельности
[заполнение с цитатами]

## Психологический профиль

### Ценности и установки
[текст + цитаты]

### Самооценка и уверенность
[текст + цитаты]

### Эмоциональный профиль
[текст + цитаты]

### Страхи и тревоги
[текст + цитаты]

### Механизмы защиты
[текст + цитаты]

## Целевой профиль

### Цели и задачи
[текст + цитаты]

### Мотивации
[текст + цитаты]

### Ожидания и критерии качества
[текст + цитаты]

## Проблемы и барьеры

### Проблемы и боли
[текст + цитаты]

### Барьерные факторы
[текст + цитаты]

### Ресурсные ограничения
[текст + цитаты]

## Поведенческий профиль

### Поведенческие паттерны и стратегии
[текст + цитаты]

### Триггеры к действию
[текст + цитаты]

### Предпочтения в интерфейсе и взаимодействии
[текст + цитаты]

## Образ жизни и контекст

### Распорядок дня
[текст]

### Контекст использования
[текст + цитаты]

### Хобби и увлечения
[текст]

### Социальная активность
[текст]

### Социальный контекст и влияния
[текст + цитаты]

### Цифровое поведение
[текст + цитаты]

### Потребительское поведение
[текст + цитаты]

## Ключевые инсайты

1. **[Название инсайта]**
   - Описание
   - Цитата/пример из текста
   - Значение для понимания поведения

2. **[Название инсайта]**
   [аналогично]

[...продолжить до 5-7 инсайтов]

---

**Теперь предоставь расшифровку интервью для анализа.**"""


def ensure_db(db_path: Path) -> None:
    conn = sqlite3.connect(str(db_path))
    try:
        cur = conn.cursor()
        cur.execute(
            """
            CREATE TABLE IF NOT EXISTS personas (
                persona_id TEXT PRIMARY KEY,
                title TEXT,
                profile_md TEXT,
                created_at TEXT
            )
            """
        )
        # v2: категориальные теги (category:value)
        cur.execute(
            """
            CREATE TABLE IF NOT EXISTS persona_tags (
                persona_id TEXT,
                category TEXT,
                value TEXT,
                PRIMARY KEY (persona_id, category, value)
            )
            """
        )
        # FTS5 для "умного" поиска по тексту
        cur.execute(
            """
            CREATE VIRTUAL TABLE IF NOT EXISTS personas_fts USING fts5(
                persona_id,
                title,
                profile_md
            )
            """
        )
        # таблица источников расшифровок (по контентному SHA)
        cur.execute(
            """
            CREATE TABLE IF NOT EXISTS sources (
                content_sha TEXT PRIMARY KEY,
                source_path TEXT,
                last_persona_id TEXT,
                updated_at TEXT
            )
            """
        )
        # версии персон (для истории)
        cur.execute(
            """
            CREATE TABLE IF NOT EXISTS persona_versions (
                persona_id TEXT PRIMARY KEY,
                title TEXT,
                profile_md TEXT,
                created_at TEXT,
                source_sha TEXT,
                active INTEGER DEFAULT 1
            )
            """
        )
        conn.commit()
    finally:
        conn.close()

def upsert_fts(db_path: Path, persona_id: str, title: str, profile_md: str) -> None:
    conn = sqlite3.connect(str(db_path))
    try:
        cur = conn.cursor()
        # REPLACE по persona_id
        cur.execute("DELETE FROM personas_fts WHERE persona_id=?", (persona_id,))
        cur.execute(
            "INSERT INTO personas_fts(persona_id, title, profile_md) VALUES (?, ?, ?)",
            (persona_id, title, profile_md),
        )
        conn.commit()
    finally:
        conn.close()


def insert_persona(db_path: Path, persona_id: str, title: str, profile_md: str) -> None:
    conn = sqlite3.connect(str(db_path))
    try:
        cur = conn.cursor()
        cur.execute(
            "INSERT OR REPLACE INTO personas(persona_id, title, profile_md, created_at) VALUES (?, ?, ?, ?)",
            (persona_id, title, profile_md, datetime.now().isoformat(timespec="seconds")),
        )
        conn.commit()
    finally:
        conn.close()
    upsert_fts(db_path, persona_id, title, profile_md)


def parse_title(profile_md: str) -> str:
    # Берём первую ненулевую строку заголовка из MD
    for line in profile_md.splitlines():
        line = line.strip()
        if not line:
            continue
        # заголовок может начинаться с '# '
        if line.startswith("#"):
            return line.lstrip("#").strip()
        return line
    return "Persona"

def sha256_text(text: str) -> str:
    h = hashlib.sha256()
    h.update(text.encode("utf-8"))
    return h.digest().hex()

def source_exists(db_path: Path, content_sha: str) -> bool:
    conn = sqlite3.connect(str(db_path))
    try:
        cur = conn.cursor()
        row = cur.execute("SELECT 1 FROM sources WHERE content_sha=?", (content_sha,)).fetchone()
        return row is not None
    finally:
        conn.close()

def upsert_source(db_path: Path, content_sha: str, source_path: str, persona_id: str | None) -> None:
    conn = sqlite3.connect(str(db_path))
    try:
        cur = conn.cursor()
        cur.execute(
            "INSERT INTO sources(content_sha, source_path, last_persona_id, updated_at) VALUES (?,?,?,?) "
            "ON CONFLICT(content_sha) DO UPDATE SET "
            "source_path=excluded.source_path, "
            "last_persona_id=COALESCE(excluded.last_persona_id, sources.last_persona_id), "
            "updated_at=excluded.updated_at",
            (content_sha, source_path, persona_id, datetime.now().isoformat(timespec='seconds')),
        )
        conn.commit()
    finally:
        conn.close()

def upsert_version(db_path: Path, persona_id: str, title: str, profile_md: str, created_at: str, content_sha: str, active: int) -> None:
    conn = sqlite3.connect(str(db_path))
    try:
        cur = conn.cursor()
        cur.execute(
            "INSERT INTO persona_versions(persona_id, title, profile_md, created_at, source_sha, active) "
            "VALUES (?,?,?,?,?,?) "
            "ON CONFLICT(persona_id) DO UPDATE SET title=excluded.title, profile_md=excluded.profile_md, created_at=excluded.created_at, source_sha=excluded.source_sha, active=excluded.active",
            (persona_id, title, profile_md, created_at, content_sha, active),
        )
        conn.commit()
    finally:
        conn.close()


def main():
    ap = argparse.ArgumentParser(description="Генерация карточек персон из .txt расшифровок")
    ap.add_argument("--txt-dir", required=True, type=Path, help="Папка с .txt файлами")
    ap.add_argument("--out-dir", required=True, type=Path, help="Куда сохранить cards_md/")
    ap.add_argument("--db-path", type=Path, default=ROOT / "db" / "personas.sqlite")
    ap.add_argument("--temperature", type=float, default=0.7)
    ap.add_argument("--max-tokens", type=int, default=int(os.getenv("LLM_MAX_TOKENS", "4000")))
    args = ap.parse_args()

    client = LLMClient()
    ensure_db(args.db_path)

    cards_dir = args.out_dir / "cards_md"
    cards_dir.mkdir(parents=True, exist_ok=True)

    for p in sorted(args.txt_dir.glob("*.txt")):
        transcript = p.read_text(encoding="utf-8")
        if not transcript:
            continue
        # пропуск уже обработанных источников
        content_sha = sha256_text(transcript)
        if source_exists(args.db_path, content_sha):
            print(f"[SKIP] {p.name}: уже есть в sources (sha={content_sha[:12]})")
            continue
        # Генерация с авто‑продолжением без изменения системного промпта.
        # Первый запрос: user = полная расшифровка без обрезки.
        last_text: str = ""
        loops = 0
        next_user = transcript
        while True:
            loops += 1
            text, stop_reason = client.chat_with_meta(
                system=PROMPT_SYSTEM,
                user=next_user,
                temperature=args.temperature,
                max_tokens= args.max_tokens,
            )
            if text:
                # Держим только последнюю (наиболее полную) версию ответа
                last_text = text
            # Если ответ обрезан по лимиту — перезапросить продолжение, передав и расшифровку, и уже написанный фрагмент
            if stop_reason in ("max_tokens", "length") and loops < 12:
                accumulated = last_text.strip()
                next_user = (
                    f"{transcript}\n\n"
                    f"Ниже уже написанная часть профиля (продолжай строго с места, где остановился; не повторяй текст, сохраняй стиль и структуру):\n"
                    f"{accumulated}\n"
                    f"\n[ПРОДОЛЖЕНИЕ]:"
                )
                continue
            break
        md = last_text.strip()
        if not md:
            md = "(пусто)"
        title = parse_title(md)
        pid_src = f"{p.stem}:{hashlib.sha256(md.encode('utf-8')).hexdigest()[:8]}"
        persona_id = "p_" + hashlib.sha256(pid_src.encode("utf-8")).hexdigest()[:12]
        fname = f"{slugify(title)}_{persona_id}.md"
        (cards_dir / fname).write_text(md, encoding="utf-8")
        now_iso = datetime.now().isoformat(timespec="seconds")
        insert_persona(args.db_path, persona_id, title, md)
        upsert_version(args.db_path, persona_id, title, md, now_iso, content_sha, 1)
        upsert_source(args.db_path, content_sha, str(p), persona_id)
        print(json.dumps({"persona_id": persona_id, "title": title, "card": str(cards_dir / fname), "source_sha": content_sha[:12]}, ensure_ascii=False))

if __name__ == "__main__":
    main()



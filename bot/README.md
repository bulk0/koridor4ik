# Телеграм-бот: общение с персонами

Этот бот помогает пользователю:
- найти нужных персон по описанию естественным языком или через фильтры;
- задать вопрос выбранным персонам и получить ответы прямо в чате;
- выгрузить ответы одного вопроса в файл, а также выгрузить лог всей беседы.

## Как устроено (человечьим языком)

- В боте два основных способа найти собеседников:
  1) По описанию: пишете «хочу поговорить с мамой в декрете, которая пользуется нейросетями» — бот находит похожих, показывает короткий список, можно выбрать нескольких.
  2) По фильтрам: видите список «ключ — значения» (например, `city: Москва/Санкт‑Петербург/...`, `ai_services: chatgpt/aliceai/...`) и сами формулируете условия вида «и/или/не».
- Когда список получается слишком большим, бот показывает 5 примеров и предлагает уточнить (город, возраст, дети, поисковик).
- На ваш вопрос бот отвечает от лица каждой выбранной персоны отдельным сообщением — удобно сравнивать.
- Есть кнопка «выгрузить ответы» (в один файл для текущего вопроса) и «выгрузить лог беседы» (после «закончить»).

## Техническая структура

- `bot/main.py` — точка входа, запуск aiogram, webhook/polling режим, регистрация роутеров.
- `bot/config.py` — конфигурация из `.env`: токен бота, режим вебхука, адреса, ключи LLM, путь к БД.
- `bot/states.py` — состояния диалога (FSM): старт, выбор режима, поиск по описанию или фильтрам, выбор кандидатов, чат, завершение.
- `bot/keyboards.py` — инлайн‑клавиатуры: выбор режима, пагинация, мультивыбор, «Готово», «Выгрузить», «Закончить».
- `bot/handlers/` — хэндлеры:
  - `start.py` — `/start`, выбор режима.
  - `nl_search.py` — логика «по описанию»: запрос, кандидаты, уточнение, мультивыбор.
  - `filter_search.py` — логика «по фильтрам»: показать категории, принять условия «и/или/не», собрать выборку.
  - `chat.py` — вопросы/ответы, выгрузки, завершение.
- `bot/services/`:
  - `async_llm.py` — асинхронная обёртка над LLM (через `asyncio.to_thread` и семафор), префлайт‑проверка.
  - `persona_search.py` — адаптер к функциям из `chat/talk.py` с TTL‑кэшем (результаты поиска и маппинг).
  - `logger.py` — структурные JSON‑логи по операциям и файлы выгрузок/логов сессий.
- `bot/requirements.txt` — зависимости бота (aiogram 3.x и прочее).

## Настройки

Требуются переменные окружения (см. `.env` в корне репозитория):
- `TELEGRAM_BOT_TOKEN` — токен бота.
- `TELEGRAM_MODE` — `webhook` или `polling`.
- `WEBHOOK_BASE_URL`, `WEBHOOK_SECRET_PATH` — для вебхука (https).
- `LLM_PROVIDER`, `LLM_MODEL`, `OPENAI_API_KEY` или `ANTHROPIC_API_KEY` — LLM.
- `PERSONAS_DB_PATH` — путь к `db/personas.sqlite` (по умолчанию из репозитория).
- `LLM_MAX_CONCURRENCY` — параллелизм LLM‑вызовов (по умолчанию 4).
- `LLM_TIMEOUT_S` — таймаут LLM‑вызовов (по умолчанию 120).

## Запуск локально (polling)

1) Установите зависимости:
```
python -m pip install -r bot/requirements.txt
```
2) Запустите:
```
python -m bot.main
```

## Деплой (в облаке)

- Режим webhook: поднять сервис за HTTPS (через Nginx/Caddy), выставить `WEBHOOK_BASE_URL` и `WEBHOOK_SECRET_PATH`, запустить `bot/main.py`.
- Смонтировать БД `db/personas.sqlite` и обеспечить персистентность каталога `runs/chats/bot` для логов/выгрузок.
- Для наблюдаемости: собрать структурные логи, опционально отправлять ошибки в Sentry/Telegram‑чат админа.


